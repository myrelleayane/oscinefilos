<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Os Cin√©filos</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/860/860306.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#101010">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- GERAL (Mantido Design Original) --- */
        :root { --bg: #101010; --card: #1f1f1f; --text: #e5e5e5; --accent: #e50914; --nav-bg: rgba(16, 16, 16, 0.98); --gold: #ffc107; --green: #46d369; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding-top: 80px; padding-bottom: 40px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Navbar */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 70px; background: var(--nav-bg); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; z-index: 1000; border-bottom: 1px solid #222; }
        .logo { font-size: 1.5em; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
        .logo span { color: var(--accent); }
        .nav-links { display: flex; gap: 35px; }
        .nav-item { cursor: pointer; color: #888; font-weight: 600; font-size: 0.95em; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-item:hover, .nav-item.active { color: white; }
        .nav-item.active { border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        .user-avatar-mini { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; min-height: 80vh; }
        .page-section { display: none; animation: fadeUp 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FOOTER (RODAP√â) --- */
        .app-footer {
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
            border-top: 1px solid #1a1a1a;
            color: #555;
            font-size: 0.9em;
        }
        .app-footer p { margin: 5px 0; }
        .app-footer i { color: var(--accent); }

        /* --- LOGIN --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-size: cover; }
        .auth-box { background: #1f1f1f; padding: 50px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .auth-box input { background: #111; border: 1px solid #444; padding: 15px; width: 100%; border-radius: 6px; margin-bottom: 15px; color: white; }
        .btn-main { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .btn-main:hover { background: #b20710; }
        .btn-guest { background: transparent; border: 1px solid #555; color: #ccc; margin-top: 10px; width: 100%; padding: 10px; cursor: pointer; }

        /* --- UI COMPONENTS --- */
        h2 { font-weight: 700; margin: 40px 0 20px 0; border-left: 4px solid var(--accent); padding-left: 15px; font-size: 1.4em; }
        .carousel-container { position: relative; }
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; scroll-behavior: smooth; scrollbar-width: none; }
        .scroll-btn { position: absolute; top: 40%; transform: translateY(-50%); background: rgba(0,0,0,0.8); color: white; border: 1px solid #333; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10; display: flex; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; }
        .carousel-container:hover .scroll-btn { opacity: 1; }
        .scroll-left { left: 0; } .scroll-right { right: 0; }
        
        .card { min-width: 160px; width: 160px; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; background: #1a1a1a; flex-shrink: 0; transition: 0.3s; }
        .card:hover { transform: scale(1.05); z-index: 2; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card img { width: 100%; height: 240px; object-fit: cover; }
        .rating-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: var(--gold); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; backdrop-filter: blur(2px); }

        /* Busca & Filtros */
        .search-container { margin: 30px auto; max-width: 800px; text-align: center; }
        .search-hero { display: flex; gap: 10px; position: relative; }
        input.search-input { flex-grow: 1; padding: 15px 20px; font-size: 1.1em; background: #222; border: 1px solid #333; color: white; border-radius: 50px; outline: none; }
        .search-filters { display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .filter-select { background: #1f1f1f; color: #ccc; border: 1px solid #333; padding: 8px 15px; border-radius: 20px; outline: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .not-found { text-align: center; padding: 40px; color: #666; width: 100%; grid-column: 1 / -1; }
        .not-found i { font-size: 3em; margin-bottom: 10px; display: block; }

        /* Di√°rio & Listas */
        .sub-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; overflow-x: auto; }
        .sub-tab-btn { background: transparent; border: none; color: #666; font-size: 1.1em; font-weight: bold; cursor: pointer; padding: 5px 10px; transition: 0.3s; white-space: nowrap; }
        .sub-tab-btn:hover, .sub-tab-btn.active { color: white; border-bottom: 3px solid var(--accent); }
        
        /* Modal & Listas */
        .list-options { display: none; position: absolute; background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px; z-index: 50; top: 100%; right: 0; min-width: 200px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .list-option-item { padding: 10px; cursor: pointer; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .list-option-item:hover { background: #333; }
        .new-list-input { width: 100%; background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; margin-top: 5px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #181818; width: 95%; max-width: 900px; max-height: 95vh; overflow-y: auto; border-radius: 12px; padding: 0; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; z-index: 10; background: rgba(0,0,0,0.5); width: 35px; height: 35px; border-radius: 50%; text-align: center; line-height: 35px; }
        .modal-header { padding: 30px; display: flex; gap: 25px; background: linear-gradient(to bottom, #1f1f1f, #181818); }
        .modal-poster { width: 140px; border-radius: 8px; align-self: flex-start; }
        .modal-info h2 { margin: 0 0 5px 0; font-size: 1.8em; line-height: 1.2; }
        .action-row { display: flex; gap: 15px; margin-top: 15px; align-items: center; border-top: 1px solid #333; padding-top: 15px; flex-wrap: wrap;}
        .watched-toggle, .list-toggle { background: #333; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9em; transition: 0.2s; border: 1px solid #444; position: relative; }
        .watched-toggle.active { color: var(--green); border-color: var(--green); background: rgba(70, 211, 105, 0.1); }
        .list-toggle:hover { background: #444; }

        /* Stats */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: #1a1a1a; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .stat-value { font-size: 2.5em; font-weight: 800; color: white; }
        .stat-label { color: #666; font-size: 0.8em; letter-spacing: 1px; text-transform: uppercase; }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding-bottom: 100px; } /* Espa√ßo extra no mobile para n√£o cortar o footer */
            .navbar { top: auto; bottom: 0; height: 75px; padding: 10px 0 20px 0; justify-content: space-around; border-top: 1px solid #222; align-items: flex-start; }
            .logo, .nav-links span { display: none; }
            .nav-links { width: 100%; justify-content: space-around; }
            .nav-item { flex-direction: column; font-size: 0.7em; }
            .nav-item i { font-size: 1.5em; margin-bottom: 4px; }
            .modal-header { flex-direction: column; text-align: center; }
            .modal-poster { margin: 0 auto; }
            .metrics-split { grid-template-columns: 1fr; }
            .profile-edit-grid { grid-template-columns: 1fr; }
            .scroll-btn { display: none; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="text-transform: uppercase; letter-spacing: 3px; font-size: 2.5em; margin-bottom: 20px;">Os <span style="color:var(--accent)">Cin√©filos</span></h1>
        <div class="auth-box">
            <h3 id="auth-title">Acesse sua conta</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button class="btn-main" onclick="handleAuth()">ENTRAR / CADASTRAR</button>
            <button class="btn-guest" onclick="entrarComoVisitante()">Apenas visitar</button>
            <p id="auth-msg" style="color: var(--gold); font-size:0.9em; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <nav class="navbar">
            <div class="logo" onclick="navegar('home')">Os <span>Cin√©filos</span></div>
            <div class="nav-links">
                <div class="nav-item active" id="nav-home" onclick="navegar('home')"><i class="fa-solid fa-house"></i> <span>In√≠cio</span></div>
                <div class="nav-item" id="nav-search" onclick="navegar('search')"><i class="fa-solid fa-magnifying-glass"></i> <span>Buscar</span></div>
                <div class="nav-item" id="nav-lists" onclick="navegar('lists')"><i class="fa-solid fa-bookmark"></i> <span>Listas</span></div>
                <div class="nav-item" id="nav-stats" onclick="navegar('stats')"><i class="fa-solid fa-chart-simple"></i> <span>Estat√≠sticas</span></div>
                <div class="nav-item" id="nav-profile" onclick="navegar('profile')">
                    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" id="nav-avatar" class="user-avatar-mini">
                    <span id="nav-profile-name">Eu</span>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="page-home" class="page-section active">
                <h2>üìÖ Em Breve</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowUpcoming"></div></div>
                <h2>üèÜ Filmes Aclamados</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowTopMovies"></div></div>
                <h2>üì∫ S√©ries do Momento</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowTopSeries"></div></div>
                
                <h2>üáßüá∑ Cinema Brasileiro</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowBR"></div></div>
                <h2>üß∏ Infantis</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowKids"></div></div>
                <h2>üé≠ Novelas & Dramas</h2>
                <div class="carousel-container"><div class="horizontal-scroll" id="rowSoaps"></div></div>
            </div>

            <div id="page-search" class="page-section">
                <div class="search-container">
                    <div class="search-hero">
                        <input type="text" id="searchInput" class="search-input" placeholder="Digite o nome..." oninput="liveSearch()">
                    </div>
                    <div class="search-filters">
                        <select id="filterType" class="filter-select" onchange="liveSearch()">
                            <option value="multi">Tudo</option>
                            <option value="movie">Filmes</option>
                            <option value="tv">S√©ries</option>
                        </select>
                        <select id="filterYear" class="filter-select" onchange="liveSearch()">
                            <option value="">Qualquer Ano</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="old">Antigos</option>
                        </select>
                    </div>
                </div>
                <div class="grid" id="gridBusca"></div>
            </div>

            <div id="page-lists" class="page-section">
                <h2>Minhas Cole√ß√µes</h2>
                <div class="sub-tabs" id="listsTabs">
                    <button class="sub-tab-btn active" onclick="loadDiary()">Hist√≥rico</button>
                    <button class="sub-tab-btn" onclick="loadUserList('quero-ver')">Quero Ver</button>
                    <button class="sub-tab-btn" style="color:var(--accent)" onclick="createNewList()">+ Criar Lista</button>
                </div>
                <div id="listContent" class="grid" style="margin-top:20px;"></div>
            </div>

            <div id="page-stats" class="page-section">
                <h2>üìä Estat√≠sticas</h2>
                <div class="stats-container">
                    <div class="stat-box"><div class="stat-value" id="statMovies">0</div><div class="stat-label">Filmes</div></div>
                    <div class="stat-box"><div class="stat-value" id="statEpisodes">0</div><div class="stat-label">Epis√≥dios</div></div>
                    <div class="stat-box"><div class="stat-value" id="statHours">0</div><div class="stat-label">Horas</div></div>
                </div>
                <div style="max-width: 600px; margin: 0 auto; background:#1a1a1a; padding:20px; border-radius:10px;">
                    <canvas id="chartGenres"></canvas>
                </div>
            </div>

            <div id="page-profile" class="page-section">
                <div class="profile-card">
                    <div class="profile-cover" id="profile-cover-bg" style="background-image: url('https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=1000&q=80');"></div>
                    <div class="profile-info">
                        <img src="" id="profile-img-preview" class="profile-avatar-large">
                        <div class="profile-name" id="profile-name-display">Carregando...</div>
                        
                        <div class="profile-edit-grid">
                            <div class="form-group">
                                <label>Nome de Exibi√ß√£o</label>
                                <input type="text" id="pf-name">
                            </div>
                            <div class="form-group">
                                <label>Capa (Link Imagem)</label>
                                <input type="text" id="pf-banner" onchange="updateProfilePreview()">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Avatar</label>
                                <input type="text" id="pf-avatar" onchange="updateProfilePreview()">
                                <div class="avatar-options">
                                    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                                    <img src="https://cdn-icons-png.flaticon.com/512/147/147144.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                                    <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                                </div>
                            </div>
                        </div>
                        <button class="btn-main" onclick="salvarPerfil()" style="margin-top:20px; width:200px;">SALVAR ALTERA√á√ïES</button>
                        <button class="btn-guest" onclick="logout()" style="margin-top:10px; width:200px; color:#d32f2f; border:none;">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <p>Criado com paix√£o por cinema.</p>
            <p>&copy; 2025 Myrelle Ayane. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="modalDetalhes" class="modal-overlay" onclick="fecharModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal('botao')">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
    // CONFIGURA√á√ÉO
    const TMDB_KEY = "cd68ef2b1840d635d19a62657d6b5a3c";
    const SUPABASE_URL = "https://jujjgjehbigxopqqvpui.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ampnamVoYmlneG9wcXF2cHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTY1MjUsImV4cCI6MjA4MDk3MjUyNX0.erCAFpHG3uKKhgBU4CvCnFd-J0E80jTTdbOcuoGG2S4";
    const BASE_URL = "https://api.themoviedb.org/3";
    const IMG_URL = "https://image.tmdb.org/t/p/w500";
    const IMG_AVATAR = "https://image.tmdb.org/t/p/w200";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null, isGuest = false;
    let currentItem = {};
    let debounceTimer;

    // --- AUTH & INIT ---
    async function init() {
        const { data } = await supabase.auth.getUser();
        if (data.user) { currentUser = data.user; loadUserData(); mostrarApp(); }
    }
    init();

    async function handleAuth() {
        const email = document.getElementById('email').value, pass = document.getElementById('password').value;
        if (!email || !pass) return alert("Preencha tudo");
        let { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) {
            let res = await supabase.auth.signUp({ email, password: pass });
            if (res.error) return alert(res.error.message);
            data = res.data;
        }
        if (data.user) { currentUser = data.user; loadUserData(); mostrarApp(); }
    }
    function entrarComoVisitante() { isGuest=true; currentUser={id:'guest'}; mostrarApp(); }
    async function logout() { await supabase.auth.signOut(); window.location.reload(); }
    function mostrarApp() { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'block'; loadHome(); }

    async function loadUserData() {
        if(isGuest) return;
        const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        if(data) {
            document.getElementById('nav-avatar').src = data.avatar_url;
            document.getElementById('nav-profile-name').innerText = data.username || "Eu";
            document.getElementById('profile-img-preview').src = data.avatar_url;
            document.getElementById('profile-name-display').innerText = data.username;
        }
        loadCustomListsTabs();
    }

    function navegar(p) {
        document.querySelectorAll('.nav-item, .page-section').forEach(e => e.classList.remove('active'));
        document.getElementById(`nav-${p}`).classList.add('active');
        document.getElementById(`page-${p}`).classList.add('active');
        if(p==='lists') loadDiary(); 
        if(p==='stats') calculateStats();
    }

    // --- HOME TURBINADA ---
    async function loadHome() {
        fetchList(`${BASE_URL}/movie/upcoming?api_key=${TMDB_KEY}&language=pt-BR`, 'rowUpcoming');
        fetchList(`${BASE_URL}/movie/top_rated?api_key=${TMDB_KEY}&language=pt-BR`, 'rowTopMovies');
        fetchList(`${BASE_URL}/tv/top_rated?api_key=${TMDB_KEY}&language=pt-BR`, 'rowTopSeries');
        // Novas Categorias
        fetchList(`${BASE_URL}/discover/movie?api_key=${TMDB_KEY}&language=pt-BR&with_original_language=pt&region=BR`, 'rowBR');
        fetchList(`${BASE_URL}/discover/movie?api_key=${TMDB_KEY}&language=pt-BR&with_genres=16,10751`, 'rowKids');
        fetchList(`${BASE_URL}/discover/tv?api_key=${TMDB_KEY}&language=pt-BR&with_genres=10766`, 'rowSoaps');
    }
    
    async function fetchList(url, cid) {
        const res = await fetch(url); const d = await res.json();
        const c = document.getElementById(cid); c.innerHTML="";
        d.results.forEach(i => c.innerHTML += `<div class="card" onclick="abrirModal('${i.id}','${i.title?'movie':'tv'}')"><img src="${IMG_URL+i.poster_path}"><div class="rating-badge">‚òÖ ${i.vote_average.toFixed(1)}</div></div>`);
    }

    // --- BUSCA AO VIVO ---
    function liveSearch() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(buscar, 500); 
    }

    async function buscar() {
        const termo = document.getElementById('searchInput').value;
        const type = document.getElementById('filterType').value;
        const year = document.getElementById('filterYear').value;
        const grid = document.getElementById('gridBusca');
        
        if(!termo) { grid.innerHTML=""; return; }
        grid.innerHTML = "<p style='color:#666'>Buscando...</p>";

        let url = `${BASE_URL}/search/${type}?api_key=${TMDB_KEY}&language=pt-BR&query=${termo}`;
        if(year && year !== 'old') url += `&primary_release_year=${year}`;

        const res = await fetch(url);
        const data = await res.json();
        grid.innerHTML = "";

        if(data.results.length === 0) {
            grid.innerHTML = `<div class="not-found"><i class="fa-solid fa-face-frown-open"></i><p>Poxa, n√£o encontramos nada com esse nome.</p></div>`;
            return;
        }

        data.results.forEach(i => {
            if(i.poster_path) {
                if(year === 'old') {
                    const y = parseInt((i.release_date || i.first_air_date || "2000").split('-')[0]);
                    if(y > 2000) return;
                }
                const tipoReal = i.media_type || (i.title ? 'movie' : 'tv');
                grid.innerHTML += `<div class="card" onclick="abrirModal('${i.id}','${tipoReal}')"><img src="${IMG_URL+i.poster_path}"><div class="rating-badge">‚òÖ ${i.vote_average.toFixed(1)}</div></div>`;
            }
        });
    }

    // --- MODAL & LISTAS ---
    async function abrirModal(id, type) {
        const modal = document.getElementById('modalDetalhes');
        const body = document.getElementById('modalBody');
        modal.style.display = 'flex'; body.innerHTML = "<p style='padding:40px; text-align:center'>Carregando...</p>";
        
        const [resDet, resCast] = await Promise.all([
            fetch(`${BASE_URL}/${type}/${id}?api_key=${TMDB_KEY}&language=pt-BR`),
            fetch(`${BASE_URL}/${type}/${id}/credits?api_key=${TMDB_KEY}&language=pt-BR`)
        ]);
        const data = await resDet.json();
        const credits = await resCast.json();
        currentItem = { id, type, title: data.title||data.name, poster: data.poster_path };

        let isWatched = false;
        if(!isGuest) {
            const { data: w } = await supabase.from('watched').select('id').eq('user_id', currentUser.id).eq('tmdb_id', id).single();
            if(w) isWatched = true;
        }

        body.innerHTML = `
            <div class="modal-header">
                <img src="${IMG_URL+data.poster_path}" class="modal-poster">
                <div class="modal-info">
                    <h2>${data.title||data.name}</h2>
                    <p style="color:#aaa">${data.release_date||data.first_air_date||''}</p>
                    <p style="margin:10px 0; color:#ddd; line-height:1.5">${data.overview||'Sem sinopse.'}</p>
                    <div class="action-row">
                        <div class="watched-toggle ${isWatched?'active':''}" onclick="toggleWatch('${id}','${type}',this)">
                            <i class="fa-solid fa-eye"></i> ${isWatched?'Visto':'Marcar Visto'}
                        </div>
                        <div class="list-toggle" onclick="toggleListMenu()">
                            <i class="fa-solid fa-plus"></i> Minhas Listas
                            <div class="list-options" id="listMenu">Carregando listas...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="cast-section"><div class="cast-list">
                ${(credits.cast||[]).slice(0,10).map(a => `<div class="actor"><img src="${a.profile_path?IMG_AVATAR+a.profile_path:'https://via.placeholder.com/80'}"><p>${a.name}</p></div>`).join('')}
            </div></div>
        `;
        loadUserListsIntoMenu();
    }

    async function loadUserListsIntoMenu() {
        if(isGuest) return;
        const menu = document.getElementById('listMenu');
        const { data: lists } = await supabase.from('user_lists').select('*').eq('user_id', currentUser.id);
        
        menu.innerHTML = "";
        const { data: items } = await supabase.from('list_items').select('list_id').eq('tmdb_id', currentItem.id);
        const inLists = new Set(items.map(i => i.list_id));

        lists.forEach(l => {
            const checked = inLists.has(l.id) ? 'fa-check-square' : 'fa-square';
            const color = inLists.has(l.id) ? 'var(--accent)' : '#aaa';
            menu.innerHTML += `
                <div class="list-option-item" onclick="toggleListItem('${l.id}', this)">
                    <span>${l.name}</span>
                    <i class="fa-regular ${checked}" style="color:${color}"></i>
                </div>`;
        });
        
        menu.innerHTML += `
            <div style="border-top:1px solid #444; padding-top:10px; margin-top:5px;">
                <input type="text" class="new-list-input" placeholder="Nova lista..." onkeypress="if(event.key==='Enter') createListFromModal(this.value)">
            </div>`;
    }

    function toggleListMenu() {
        const menu = document.getElementById('listMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    async function toggleListItem(listId, el) {
        const icon = el.querySelector('i');
        const isAdded = icon.classList.contains('fa-check-square');
        
        if(isAdded) {
            await supabase.from('list_items').delete().eq('list_id', listId).eq('tmdb_id', currentItem.id);
            icon.classList.replace('fa-check-square', 'fa-square');
            icon.style.color = '#aaa';
        } else {
            await supabase.from('list_items').insert([{
                list_id: listId, tmdb_id: currentItem.id, 
                media_type: currentItem.type, poster_path: currentItem.poster, title: currentItem.title 
            }]);
            icon.classList.replace('fa-square', 'fa-check-square');
            icon.style.color = 'var(--accent)';
        }
    }

    async function createListFromModal(name) {
        if(!name) return;
        await supabase.from('user_lists').insert([{ user_id: currentUser.id, name: name }]);
        loadUserListsIntoMenu();
    }

    async function loadCustomListsTabs() {
        if(isGuest) return;
        const { data } = await supabase.from('user_lists').select('*').eq('user_id', currentUser.id).eq('is_system', false);
        const tabs = document.getElementById('listsTabs');
        while(tabs.children.length > 2) { tabs.removeChild(tabs.lastChild); }
        
        const createBtn = document.createElement('button');
        createBtn.className = 'sub-tab-btn';
        createBtn.style.color = 'var(--accent)';
        createBtn.innerText = '+ Criar';
        createBtn.onclick = createNewList;

        data.forEach(l => {
            const btn = document.createElement('button');
            btn.className = 'sub-tab-btn';
            btn.innerText = l.name;
            btn.onclick = () => loadUserList(l.id);
            tabs.appendChild(btn);
        });
        tabs.appendChild(createBtn);
    }

    async function loadDiary() {
        const container = document.getElementById('listContent');
        container.innerHTML = "Carregando...";
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id).order('created_at', {ascending:false});
        renderListItems(data, container, true);
    }

    async function loadUserList(listIdOrType) {
        const container = document.getElementById('listContent');
        container.innerHTML = "Carregando...";
        let query = supabase.from('list_items').select('*');
        
        if(listIdOrType === 'quero-ver') {
            const { data: list } = await supabase.from('user_lists').select('id').eq('user_id', currentUser.id).eq('is_system', true).single();
            if(list) query = query.eq('list_id', list.id);
            else { container.innerHTML = "Lista n√£o encontrada."; return; }
        } else {
            query = query.eq('list_id', listIdOrType);
        }
        
        const { data } = await query;
        renderListItems(data, container, false);
    }

    async function renderListItems(data, container, isHistory) {
        container.innerHTML = "";
        if(!data || data.length === 0) { container.innerHTML = "<p style='color:#666'>Lista vazia.</p>"; return; }

        for(let item of data) {
            let title = item.title;
            let poster = item.poster_path;
            
            if(isHistory) {
                const res = await fetch(`${BASE_URL}/${item.media_type}/${item.tmdb_id}?api_key=${TMDB_KEY}&language=pt-BR`);
                const m = await res.json();
                title = m.title || m.name;
                poster = m.poster_path;
            }

            container.innerHTML += `
                <div class="card" onclick="abrirModal('${item.tmdb_id}', '${item.media_type}')">
                    <img src="${IMG_URL+poster}">
                    <div class="rating-badge" style="bottom:0; top:auto; width:100%; text-align:center; background:rgba(0,0,0,0.7)">${title}</div>
                </div>`;
        }
    }

    async function createNewList() {
        const name = prompt("Nome da nova lista:");
        if(name) {
            await supabase.from('user_lists').insert([{ user_id: currentUser.id, name: name }]);
            loadCustomListsTabs();
        }
    }

    async function toggleWatch(id, type, btn) {
        if(isGuest) return alert("Fa√ßa login.");
        const { data } = await supabase.from('watched').select('id').eq('user_id', currentUser.id).eq('tmdb_id', id).single();
        if(data) {
            await supabase.from('watched').delete().eq('id', data.id);
            btn.classList.remove('active'); btn.innerHTML = '<i class="fa-solid fa-eye"></i> Marcar Visto';
        } else {
            await supabase.from('watched').insert([{user_id: currentUser.id, tmdb_id: id, media_type: type}]);
            btn.classList.add('active'); btn.innerHTML = '<i class="fa-solid fa-eye"></i> Visto';
        }
    }

    async function calculateStats() {
        if(isGuest) return;
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id);
        let m=0, e=0;
        data.forEach(i => i.media_type === 'movie' ? m++ : e++);
        document.getElementById('statMovies').innerText = m;
        document.getElementById('statEpisodes').innerText = e;
        
        new Chart(document.getElementById('chartGenres'), {
            type: 'bar',
            data: {
                labels: ['Filmes', 'Epis√≥dios'],
                datasets: [{ label: 'Total', data: [m, e], backgroundColor: ['#e50914', '#ffffff'] }]
            },
            options: { plugins: { legend: { display:false } }, scales: { y: { beginAtZero: true, grid: { color: '#333' } } } }
        });
    }

    // --- PERFIL ---
    function selectAvatar(url) { document.getElementById('pf-avatar').value=url; updateProfilePreview(); }
    function updateProfilePreview() { document.getElementById('profile-img-preview').src=document.getElementById('pf-avatar').value; document.getElementById('profile-cover-bg').style.backgroundImage=`url('${document.getElementById('pf-banner').value}')`; }
    async function salvarPerfil() {
        if(isGuest) return alert("Visitante n√£o pode editar.");
        const updates = { id: currentUser.id, username: document.getElementById('pf-name').value, avatar_url: document.getElementById('pf-avatar').value, banner_url: document.getElementById('pf-banner').value };
        const { error } = await supabase.from('profiles').upsert(updates);
        if(error) alert("Erro: " + error.message); else { alert("Salvo!"); window.location.reload(); }
    }

    function fecharModal(e){if(e==='botao'||e.target.id==='modalDetalhes')document.getElementById('modalDetalhes').style.display='none'}
</script>
</body>
</html>
