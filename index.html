<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Os Cin√©filos</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/860/860306.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#101010">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- GERAL --- */
        :root { --bg: #101010; --card: #1f1f1f; --text: #e5e5e5; --accent: #e50914; --nav-bg: rgba(16, 16, 16, 0.98); --gold: #ffc107; --green: #46d369; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding-top: 80px; padding-bottom: 90px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Navbar */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 70px; background: var(--nav-bg); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; z-index: 1000; border-bottom: 1px solid #222; }
        .logo { font-size: 1.5em; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
        .logo span { color: var(--accent); }
        .nav-links { display: flex; gap: 35px; }
        .nav-item { cursor: pointer; color: #888; font-weight: 600; font-size: 0.95em; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-item:hover, .nav-item.active { color: white; }
        .nav-item.active { border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        .user-avatar-mini { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
        
        /* Mobile Top Bar */
        .mobile-logo-bar { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: var(--nav-bg); z-index: 1001; align-items: center; justify-content: center; border-bottom: 1px solid #222; backdrop-filter: blur(10px); }
        .mobile-logo { font-size: 1.2em; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        .mobile-logo span { color: var(--accent); }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .page-section { display: none; animation: fadeUp 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-size: cover; }
        .auth-box { background: #1f1f1f; padding: 50px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .auth-box input { background: #111; border: 1px solid #444; padding: 15px; width: 100%; border-radius: 6px; margin-bottom: 15px; color: white; }
        .btn-main { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .btn-main:hover { background: #b20710; }
        .btn-guest { background: transparent; border: 1px solid #555; color: #ccc; margin-top: 10px; width: 100%; padding: 10px; cursor: pointer; }

        /* UI Components */
        h2 { font-weight: 700; margin: 40px 0 20px 0; border-left: 4px solid var(--accent); padding-left: 15px; font-size: 1.4em; }
        .carousel-container { position: relative; }
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; scroll-behavior: smooth; scrollbar-width: none; }
        .scroll-btn { position: absolute; top: 40%; transform: translateY(-50%); background: rgba(0,0,0,0.8); color: white; border: 1px solid #333; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 10; display: flex; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; font-size: 1.2em;}
        .carousel-container:hover .scroll-btn { opacity: 1; }
        .scroll-left { left: -20px; } .scroll-right { right: -20px; }
        .scroll-btn:hover { background: var(--accent); border-color: var(--accent); }

        .card { min-width: 160px; width: 160px; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; background: #1a1a1a; flex-shrink: 0; transition: 0.3s; }
        .card:hover { transform: scale(1.05); z-index: 2; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card img { width: 100%; height: 240px; object-fit: cover; }
        .rating-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: var(--gold); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; backdrop-filter: blur(2px); }

        /* Busca */
        .search-hero { margin: 30px auto; max-width: 600px; display: flex; gap: 10px; }
        input.search-input { flex-grow: 1; padding: 15px 20px; font-size: 1.1em; background: #222; border: 1px solid #333; color: white; border-radius: 50px; outline: none; }
        .search-btn-icon { width: 50px; height: 50px; border-radius: 50%; background: var(--accent); border: none; color: white; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .search-btn-icon:hover { background: #b20710; transform: scale(1.1); }
        .search-filters { display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .filter-select { background: #1f1f1f; color: #ccc; border: 1px solid #333; padding: 8px 15px; border-radius: 20px; outline: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .not-found { text-align: center; padding: 40px; color: #666; width: 100%; grid-column: 1 / -1; }
        .not-found i { font-size: 3em; margin-bottom: 10px; display: block; }

        /* Di√°rio & Listas */
        .sub-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; overflow-x: auto; }
        .sub-tab-btn { background: transparent; border: none; color: #666; font-size: 1.1em; font-weight: bold; cursor: pointer; padding: 5px 10px; transition: 0.3s; white-space: nowrap; }
        .sub-tab-btn:hover, .sub-tab-btn.active { color: white; border-bottom: 3px solid var(--accent); }
        
        .list-options { display: none; position: absolute; background: #222; border: 1px solid #444; border-radius: 8px; padding: 0; z-index: 50; top: 110%; right: 0; min-width: 240px; box-shadow: 0 5px 20px rgba(0,0,0,0.8); overflow: hidden; }
        .list-option-item { padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .list-option-item:hover { background: #333; }
        .list-create-area { padding: 10px; background: #1a1a1a; display: flex; gap: 5px; }
        .new-list-input { flex-grow: 1; background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; font-size: 0.9em; }
        .new-list-btn { background: var(--accent); border: none; color: white; width: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;}

        .diary-section-content { display: none; }
        .diary-section-content.active { display: block; animation: fadeUp 0.3s; }
        .diary-item { display: flex; gap: 15px; background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--accent); position: relative; }
        .diary-poster { width: 50px; height: 75px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .diary-info { flex-grow: 1; }
        .diary-date { color: var(--accent); font-size: 0.8em; font-weight: bold; }
        .diary-title { font-size: 1em; font-weight: bold; margin: 3px 0; cursor: pointer;}
        .diary-meta { color: #777; font-size: 0.9em; }
        .diary-remove { position: absolute; right: 15px; top: 15px; color: #444; cursor: pointer; }
        .diary-remove:hover { color: #d32f2f; }

        /* CARTOES DE A√á√ÉO (ADD/DELETE) NAS LISTAS */
        .action-card-small {
            width: 160px; height: 240px; /* Tamanho igual aos posters */
            border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; font-size: 0.9em; font-weight: 600; gap: 10px;
            border: 1px dashed #444; background: transparent; color: #666;
            flex-shrink: 0;
        }
        .action-card-small.add:hover { border-color: var(--accent); color: var(--accent); background: #151515; }
        .action-card-small.delete { border-color: #d32f2f; color: #d32f2f; height: 60px; width: 100%; margin-bottom: 15px; flex-direction: row;} /* Delete √© uma barra horizontal */
        .action-card-small.delete:hover { background: #2a1212; }
        
        /* Bot√£o de remover item da lista */
        .card-remove-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; transition: 0.2s; border: 1px solid #444; }
        .card-remove-btn:hover { background: #d32f2f; border-color: #d32f2f; }

        /* Stats */
        .metrics-split { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .metric-group h3 { border-bottom: 1px solid #333; padding-bottom: 10px; color: #aaa; font-size: 1em; text-transform: uppercase; letter-spacing: 1px; }
        .stat-box { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .stat-box:hover { border-color: var(--accent); background: #222; }
        .stat-value { font-size: 2em; font-weight: 800; color: white; }
        .stat-label { color: #666; font-size: 0.9em; text-transform: uppercase; }
        .stat-icon { font-size: 2em; color: #333; }
        #page-stats-details .btn-back-modal { display: inline-flex; margin-bottom: 20px; align-items: center; gap: 5px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #181818; width: 95%; max-width: 900px; max-height: 95vh; overflow-y: auto; border-radius: 12px; padding: 0; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; z-index: 10; background: rgba(0,0,0,0.5); width: 35px; height: 35px; border-radius: 50%; text-align: center; line-height: 35px; }
        .modal-header { padding: 30px; display: flex; gap: 25px; background: linear-gradient(to bottom, #1f1f1f, #181818); }
        .modal-poster { width: 140px; border-radius: 8px; align-self: flex-start; }
        .modal-info h2 { margin: 0 0 5px 0; font-size: 1.8em; line-height: 1.2; }
        .action-row { display: flex; gap: 15px; margin-top: 15px; align-items: center; border-top: 1px solid #333; padding-top: 15px; flex-wrap: wrap;}
        .watched-toggle, .list-toggle { background: #333; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9em; transition: 0.2s; border: 1px solid #444; position: relative; }
        .watched-toggle.active { color: var(--green); border-color: var(--green); background: rgba(70, 211, 105, 0.1); }
        .list-toggle:hover { background: #444; }

        /* Modal Data */
        #dateModal .modal-content { max-width: 350px; text-align: center; padding: 30px; }
        .date-picker-container input { width: 100%; padding: 12px; margin: 10px 0; background: #2a2a2a; border: 1px solid #333; color: white; border-radius: 5px; font-size: 1em; color-scheme: dark; }
        .date-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #ccc; flex: 1; padding: 10px; border-radius: 5px; cursor: pointer; }
        .btn-confirm { background: var(--green); border: none; color: white; flex: 1; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* S√©ries & Elenco */
        .seasons-container { padding: 0 30px; margin-top: 20px; }
        .season-item { margin-bottom: 10px; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .season-header-row { display: flex; align-items: center; background: #222; }
        .season-btn { flex-grow: 1; background: transparent; border: none; padding: 15px; color: white; text-align: left; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; font-size: 1em; }
        .season-eye-btn { padding: 0 20px; cursor: pointer; color: #555; display: flex; align-items: center; font-size: 1.2em;}
        .season-eye-btn.active { color: var(--green); }
        .season-content { display: none; background: #151515; }
        .episode-item { padding: 15px; border-bottom: 1px solid #2a2a2a; display: flex; gap: 15px; align-items: flex-start; }
        .episode-eye { font-size: 1.2em; color: #444; cursor: pointer; padding-top: 2px; }
        .episode-eye.active { color: var(--green); }
        .episode-info { flex-grow: 1; cursor: pointer; }
        .episode-body { display: none; color: #999; font-size: 0.9em; margin-top: 5px; line-height: 1.5; }
        
        .cast-section { padding: 20px 30px; }
        .cast-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: thin; }
        .actor { min-width: 90px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .actor:hover { transform: scale(1.05); }
        .actor img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px solid #333; margin-bottom: 5px; }
        .actor p { font-size: 0.8em; text-align: center; color: #ccc; margin: 0; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }
        
        .person-view-header { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .person-view-header img { width: 120px; height: 180px; object-fit: cover; border-radius: 5px; }
        .btn-back-modal { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .filmography-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .filmography-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .filmography-item img:hover { transform: scale(1.05); }

        /* Coment√°rios */
        .reviews-section { padding: 30px; background: #111; border-top: 1px solid #222; }
        .comment-input-area { background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; margin-bottom: 30px; }
        .star-rating { display: flex; justify-content: center; gap: 15px; font-size: 30px; color: #333; cursor: pointer; margin-bottom: 15px; }
        .star-rating i.filled { color: var(--gold); }
        textarea { width: 100%; height: 90px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; padding: 15px; resize: none; font-family: inherit; font-size: 1em; }
        textarea:focus { outline: none; border-color: var(--accent); }
        .review-box { background: #222; padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; color: #aaa; }
        .user-badge { display: flex; align-items: center; gap: 10px; color: white; font-weight: bold; }
        .delete-btn { cursor: pointer; color: #555; transition: 0.2s; }
        .delete-btn:hover { color: #d32f2f; }

        /* Perfil */
        .profile-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; margin-bottom: 20px; }
        .profile-cover { height: 180px; background-size: cover; background-position: center; position: relative; background-color: #333; }
        .profile-info { padding: 0 30px 30px 30px; position: relative; display: flex; flex-direction: column; align-items: center; margin-top: -60px; }
        .profile-avatar-large { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--card); object-fit: cover; background: #000; }
        .profile-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 600px; margin-top: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; text-align: left; }
        .form-group input { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; }
        .avatar-options { display: flex; gap: 15px; justify-content: center; margin-top: 10px; }
        .avatar-opt { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; opacity: 0.6; }
        .avatar-opt:hover { opacity: 1; border-color: var(--accent); transform: scale(1.1); }

        /* FOOTER */
        .app-footer { text-align: center; padding: 40px 20px; margin-top: 60px; border-top: 1px solid #1a1a1a; color: #555; font-size: 0.9em; }
        .app-footer p { margin: 5px 0; }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding-top: 60px; padding-bottom: 80px; }
            .navbar { top: auto; bottom: 0; height: 75px; padding: 10px 0 20px 0; justify-content: space-around; border-top: 1px solid #222; align-items: flex-start; z-index: 2000; }
            .logo, .nav-links span { display: none; }
            .nav-links { width: 100%; justify-content: space-around; }
            .nav-item { flex-direction: column; font-size: 0.7em; }
            .nav-item i { font-size: 1.5em; margin-bottom: 4px; }
            .modal-header { flex-direction: column; text-align: center; }
            .modal-poster { margin: 0 auto; }
            .metrics-split { grid-template-columns: 1fr; }
            .profile-edit-grid { grid-template-columns: 1fr; }
            .scroll-btn { display: none; }
            .mobile-logo-bar { display: flex; } /* Mostra no mobile */
        }
    </style>
</head>
<body>

    <div class="mobile-logo-bar">
        <div class="mobile-logo">Os <span>Cin√©filos</span></div>
    </div>

    <div id="auth-screen">
        <h1 style="text-transform: uppercase; letter-spacing: 3px; font-size: 2.5em; margin-bottom: 20px;">Os <span style="color:var(--accent)">Cin√©filos</span></h1>
        <div class="auth-box">
            <h3 id="auth-title" style="margin-top:0">Acesse sua conta</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button class="btn-main" onclick="handleAuth()">ENTRAR / CADASTRAR</button>
            <button class="btn-guest" onclick="entrarComoVisitante()">Apenas visitar</button>
            <p id="auth-msg" style="color: var(--gold); font-size:0.9em; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <nav class="navbar">
            <div class="logo" onclick="navegar('home')">Os <span>Cin√©filos</span></div>
            <div class="nav-links">
                <div class="nav-item active" id="nav-home" onclick="navegar('home')"><i class="fa-solid fa-house"></i> <span>In√≠cio</span></div>
                <div class="nav-item" id="nav-search" onclick="navegar('search')"><i class="fa-solid fa-magnifying-glass"></i> <span>Buscar</span></div>
                <div class="nav-item" id="nav-lists" onclick="navegar('lists')"><i class="fa-solid fa-bookmark"></i> <span>Listas</span></div>
                <div class="nav-item" id="nav-stats" onclick="navegar('stats')"><i class="fa-solid fa-chart-simple"></i> <span>Estat√≠sticas</span></div>
                <div class="nav-item" id="nav-profile" onclick="navegar('profile')">
                    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" id="nav-avatar" class="user-avatar-mini">
                    <span id="nav-profile-name">Eu</span>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="page-home" class="page-section active">
                <h2>üìÖ Em Breve</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowUpcoming', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowUpcoming">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowUpcoming', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <h2>üèÜ Filmes Aclamados</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowTopMovies', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowTopMovies">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowTopMovies', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <h2>üì∫ S√©ries do Momento</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowTopSeries', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowTopSeries">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowTopSeries', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                
                <h2>üáßüá∑ Cinema Brasileiro</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowBR', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowBR">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowBR', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <h2>üß∏ Infantis</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowKids', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowKids">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowKids', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <h2>üé≠ Novelas & Dramas</h2>
                <div class="carousel-container">
                    <button class="scroll-btn scroll-left" onclick="scrollContainer('rowSoaps', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="horizontal-scroll" id="rowSoaps">Carregando...</div>
                    <button class="scroll-btn scroll-right" onclick="scrollContainer('rowSoaps', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div id="page-search" class="page-section">
                <div class="search-container">
                    <div class="search-hero">
                        <input type="text" id="searchInput" class="search-input" placeholder="Digite o nome..." oninput="liveSearch()">
                        <button class="search-btn-icon" onclick="buscar()"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                    <div class="search-filters">
                        <select id="filterType" class="filter-select" onchange="liveSearch()"><option value="multi">Tudo</option><option value="movie">Filmes</option><option value="tv">S√©ries</option></select>
                        <select id="filterYear" class="filter-select" onchange="liveSearch()"><option value="">Ano</option><option value="2025">2025</option><option value="2024">2024</option><option value="old">Antigos</option></select>
                    </div>
                </div>
                <div class="grid" id="gridBusca"></div>
            </div>

            <div id="page-lists" class="page-section">
                <h2>Minhas Cole√ß√µes</h2>
                <div class="sub-tabs" id="listsTabs">
                    <button class="sub-tab-btn active" onclick="switchDiaryTab('movies', this)">üé¨ Filmes</button>
                    <button class="sub-tab-btn" onclick="switchDiaryTab('series', this)">üì∫ S√©ries</button>
                    <button class="sub-tab-btn" style="color:var(--accent)" onclick="createNewList()">+ Criar Lista</button>
                </div>
                
                <div id="diary-movies-container" class="diary-section-content active">Carregando filmes...</div>
                <div id="diary-series-container" class="diary-section-content">Carregando s√©ries...</div>
                <div id="listContent" class="diary-section-content" style="display:none; flex-wrap:wrap; gap:15px; align-items:flex-start"></div>
            </div>

            <div id="page-stats" class="page-section">
                <h2>üìä Estat√≠sticas</h2>
                <div class="metrics-split">
                    <div class="metric-group">
                        <h3>üé¨ Filmes</h3>
                        <div class="stat-box" onclick="openDetailedStats('movie')">
                            <div class="stat-value" id="statMovies">0</div>
                            <div class="stat-label">Total</div>
                            <i class="fa-solid fa-film stat-icon"></i>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statHoursMovies">0</div>
                            <div class="stat-label">Horas</div>
                            <i class="fa-solid fa-clock stat-icon"></i>
                        </div>
                    </div>
                    <div class="metric-group">
                        <h3>üì∫ S√©ries</h3>
                        <div class="stat-box" onclick="openDetailedStats('tv')">
                            <div class="stat-value" id="statSeries">0</div>
                            <div class="stat-label">S√©ries</div>
                            <i class="fa-solid fa-tv stat-icon"></i>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statEpisodes">0</div>
                            <div class="stat-label">Epis√≥dios</div>
                            <i class="fa-solid fa-list-ol stat-icon"></i>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statHoursSeries">0</div>
                            <div class="stat-label">Horas</div>
                            <i class="fa-solid fa-hourglass-half stat-icon"></i>
                        </div>
                    </div>
                </div>
                <div style="max-width: 600px; margin: 0 auto; background:#1a1a1a; padding:20px; border-radius:10px;">
                    <canvas id="chartGenres"></canvas>
                </div>
            </div>

            <div id="page-stats-details" class="page-section">
                <div class="btn-back-modal" onclick="closeDetailedStats()" style="display:inline-flex; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Voltar</div>
                <h2 id="statsDetailTitle">Detalhes</h2>
                <div class="grid" id="statsDetailGrid"></div>
            </div>

            <div id="page-profile" class="page-section">
                <div class="profile-card">
                    <div class="profile-cover" id="profile-cover-bg" style="background-image: url('https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=1000&q=80');"></div>
                    <div class="profile-info">
                        <img src="" id="profile-img-preview" class="profile-avatar-large">
                        <div class="profile-name" id="profile-name-display">Carregando...</div>
                        <div class="profile-edit-grid">
                            <div class="form-group"><label>Nome</label><input type="text" id="pf-name"></div>
                            <div class="form-group"><label>Capa (URL)</label><input type="text" id="pf-banner" onchange="updateProfilePreview()"></div>
                            <div class="form-group" style="grid-column: span 2;"><label>Avatar</label><input type="text" id="pf-avatar" onchange="updateProfilePreview()"></div>
                        </div>
                        <div class="avatar-options">
                            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                            <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                            <img src="https://cdn-icons-png.flaticon.com/512/147/147144.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                            <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar-opt" onclick="selectAvatar(this.src)">
                        </div>
                        <button class="btn-main" onclick="salvarPerfil()" style="margin-top:20px; width:200px;">SALVAR ALTERA√á√ïES</button>
                        <button class="btn-guest" onclick="logout()" style="margin-top:10px; width:200px; color:#d32f2f; border:none;">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <p>Criado para f√£s das artes Cinematogr√°ficas.</p>
            <p>&copy; 2025 Myrelle Ayane. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="modalDetalhes" class="modal-overlay" onclick="fecharModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal('botao')">&times;</span>
            <div id="modalBody"></div>
            
            <div class="reviews-section" id="reviewsSection">
                <h3 id="reviewTitle" style="color:var(--accent); margin-top:0">üí¨ Coment√°rios</h3>
                <div class="comment-input-area">
                    <div id="starInput" class="star-rating">
                        <i class="fa-solid fa-star" onclick="setRate(1)"></i><i class="fa-solid fa-star" onclick="setRate(2)"></i><i class="fa-solid fa-star" onclick="setRate(3)"></i><i class="fa-solid fa-star" onclick="setRate(4)"></i><i class="fa-solid fa-star" onclick="setRate(5)"></i>
                    </div>
                    <textarea id="reviewText" placeholder="Escreva sua opini√£o..."></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <label style="color:#aaa; font-size:0.9em; cursor:pointer"><input type="checkbox" id="anonCheck"> Modo An√¥nimo</label>
                        <button class="btn-main" onclick="publicarReview()" style="width:auto; padding: 8px 30px;">PUBLICAR</button>
                    </div>
                </div>
                <div id="reviewsList" class="review-list"></div>
            </div>
        </div>
    </div>

    <div id="dateModal" class="modal-overlay" style="z-index: 6000;">
        <div class="modal-content">
            <h3 style="margin-top:0">Quando voc√™ assistiu?</h3>
            <div class="date-picker-container">
                <label style="display:block; text-align:left; color:#888; font-size:0.9em">Data</label>
                <input type="date" id="watchDate">
                <label style="display:block; text-align:left; color:#888; font-size:0.9em; margin-top:10px;">Hor√°rio</label>
                <input type="time" id="watchTime">
            </div>
            <div class="date-actions">
                <button class="btn-cancel" onclick="closeDateModal()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmWatch()">SALVAR</button>
            </div>
        </div>
    </div>

<script>
    const TMDB_KEY = "cd68ef2b1840d635d19a62657d6b5a3c";
    const SUPABASE_URL = "https://jujjgjehbigxopqqvpui.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ampnamVoYmlneG9wcXF2cHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTY1MjUsImV4cCI6MjA4MDk3MjUyNX0.erCAFpHG3uKKhgBU4CvCnFd-J0E80jTTdbOcuoGG2S4";
    const BASE_URL = "https://api.themoviedb.org/3";
    const IMG_URL = "https://image.tmdb.org/t/p/w500";
    const IMG_AVATAR = "https://image.tmdb.org/t/p/w200";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null, isGuest = false;
    let currentItem = {}, currentRating = 0, currentEpisode = null;
    let watchedSet = new Set();
    let backupModalFilme = "";
    let pendingWatchAction = null; 
    let debounceTimer;
    let currentActiveListId = null;

    // --- AUTH ---
    async function init() {
        const { data } = await supabase.auth.getUser();
        if (data.user) { currentUser = data.user; await loadUserData(); mostrarApp(); }
    }
    init();

    async function handleAuth() {
        const email = document.getElementById('email').value, pass = document.getElementById('password').value;
        if (!email || !pass) return alert("Preencha tudo");
        let { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) {
            let res = await supabase.auth.signUp({ email, password: pass });
            if (res.error) return alert(res.error.message);
            data = res.data;
        }
        if (data.user) { currentUser = data.user; await loadUserData(); mostrarApp(); }
    }
    function entrarComoVisitante() { isGuest=true; currentUser={id:'guest'}; mostrarApp(); }
    async function logout() { await supabase.auth.signOut(); window.location.reload(); }
    function mostrarApp() { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'block'; loadHome(); }

    async function loadUserData() {
        if(isGuest) return;
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        if(profile) {
            const nome = profile.username || "Usu√°rio";
            document.getElementById('nav-avatar').src = profile.avatar_url;
            document.getElementById('nav-profile-name').innerText = nome;
            document.getElementById('profile-img-preview').src = profile.avatar_url;
            document.getElementById('profile-cover-bg').style.backgroundImage = `url('${profile.banner_url}')`;
            document.getElementById('profile-name-display').innerText = nome;
            document.getElementById('pf-name').value = nome;
            document.getElementById('pf-avatar').value = profile.avatar_url;
            document.getElementById('pf-banner').value = profile.banner_url;
        }
        const { data: watched } = await supabase.from('watched').select('*').eq('user_id', currentUser.id);
        watchedSet.clear();
        watched.forEach(w => watchedSet.add(w.media_type==='movie' ? `${w.tmdb_id}_m` : `${w.tmdb_id}_tv_${w.season_number}_${w.episode_number}`));
        loadCustomListsTabs();
    }

    function navegar(p) {
        document.querySelectorAll('.nav-item, .page-section').forEach(e => e.classList.remove('active'));
        document.getElementById(`nav-${p}`).classList.add('active');
        document.getElementById(`page-${p}`).classList.add('active');
        document.getElementById('page-stats-details').classList.remove('active');
        if(p==='lists') loadDiary(); 
        if(p==='stats') calculateStats();
        if(p==='search') document.getElementById('searchInput').focus();
    }

    // --- HOME ---
    async function loadHome() {
        fetchList(`${BASE_URL}/movie/upcoming?api_key=${TMDB_KEY}&language=pt-BR`, 'rowUpcoming');
        fetchList(`${BASE_URL}/movie/top_rated?api_key=${TMDB_KEY}&language=pt-BR`, 'rowTopMovies');
        fetchList(`${BASE_URL}/tv/top_rated?api_key=${TMDB_KEY}&language=pt-BR`, 'rowTopSeries');
        fetchList(`${BASE_URL}/discover/movie?api_key=${TMDB_KEY}&language=pt-BR&with_original_language=pt&region=BR`, 'rowBR');
        fetchList(`${BASE_URL}/discover/movie?api_key=${TMDB_KEY}&language=pt-BR&with_genres=16,10751`, 'rowKids');
        fetchList(`${BASE_URL}/discover/tv?api_key=${TMDB_KEY}&language=pt-BR&with_genres=10766`, 'rowSoaps');
    }
    async function fetchList(url, cid) {
        const res = await fetch(url); const d = await res.json();
        const c = document.getElementById(cid); c.innerHTML="";
        d.results.forEach(i => c.innerHTML += `<div class="card" onclick="abrirModal('${i.id}','${i.title?'movie':'tv'}')"><img src="${IMG_URL+i.poster_path}"><div class="rating-badge">‚òÖ ${i.vote_average.toFixed(1)}</div></div>`);
    }
    function scrollContainer(id, dir) { document.getElementById(id).scrollBy({ left: dir * 300, behavior: 'smooth' }); }

    // --- BUSCA ---
    function liveSearch() { clearTimeout(debounceTimer); debounceTimer = setTimeout(buscar, 500); }
    async function buscar() {
        const termo = document.getElementById('searchInput').value;
        const type = document.getElementById('filterType').value;
        const year = document.getElementById('filterYear').value;
        const grid = document.getElementById('gridBusca');
        
        if(!termo) { grid.innerHTML=""; return; }
        let url = `${BASE_URL}/search/${type}?api_key=${TMDB_KEY}&language=pt-BR&query=${termo}`;
        if(year && year !== 'old') url += `&primary_release_year=${year}`;

        const res = await fetch(url);
        const data = await res.json();
        grid.innerHTML = "";
        
        if(!data.results.length) grid.innerHTML = "<p style='padding:20px; color:#666'>Nada encontrado.</p>";

        data.results.forEach(i => {
            if (i.media_type === 'person' && i.known_for && i.known_for.length > 0) {
                 i.known_for.forEach(k => {
                     if(k.poster_path) {
                         const tipoReal = k.media_type || (k.title ? 'movie' : 'tv');
                         grid.innerHTML += `<div class="card" onclick="abrirModal('${k.id}','${tipoReal}')"><img src="${IMG_URL+k.poster_path}"><div class="rating-badge">‚òÖ ${k.vote_average.toFixed(1)}</div></div>`;
                     }
                 });
            } else if(i.poster_path) {
                const tipoReal = i.media_type || (i.title ? 'movie' : 'tv');
                grid.innerHTML += `<div class="card" onclick="abrirModal('${i.id}','${tipoReal}')"><img src="${IMG_URL+i.poster_path}"><div class="rating-badge">‚òÖ ${i.vote_average.toFixed(1)}</div></div>`;
            }
        });
    }

    // --- MODAL & LISTAS ---
    async function abrirModal(id, type) {
        const modal = document.getElementById('modalDetalhes');
        const body = document.getElementById('modalBody');
        modal.style.display = 'flex'; body.innerHTML = "<p style='padding:40px; text-align:center'>Carregando...</p>";
        
        try {
            const [resDet, resCast] = await Promise.all([
                fetch(`${BASE_URL}/${type}/${id}?api_key=${TMDB_KEY}&language=pt-BR`),
                fetch(`${BASE_URL}/${type}/${id}/credits?api_key=${TMDB_KEY}&language=pt-BR`)
            ]);
            const data = await resDet.json();
            const credits = await resCast.json();
            currentItem = { id, type, title: data.title||data.name, poster: data.poster_path, runtime: data.runtime||30 };
            currentEpisode = null;

            const isW = watchedSet.has(`${id}_m`);
            const eyeBtn = type === 'movie' ? `<div class="watched-toggle ${isW?'active':''}" onclick="toggleWatch('${id}','movie',${currentItem.runtime},this)"><i class="fa-solid fa-eye"></i> ${isW?'Visto':'Marcar Visto'}</div>` : '';
            
            let seasonsHtml = "";
            if(type === 'tv') {
                seasonsHtml = `<div class="seasons-container"><h3>Temporadas</h3>`;
                for(let i=1; i<=data.number_of_seasons; i++) {
                    seasonsHtml += `
                    <div class="season-item">
                        <div class="season-header-row">
                            <button class="season-btn" onclick="loadSeason('${id}',${i})">Temporada ${i} <i class="fa-solid fa-chevron-down"></i></button>
                            <div class="season-eye-btn" onclick="clickSeasonWatch('${id}', ${i}, this)" title="Marcar temporada"><i class="fa-solid fa-eye"></i></div>
                        </div>
                        <div class="season-content" id="season-${i}"></div>
                    </div>`;
                }
                seasonsHtml += "</div>";
            }

            let htmlElenco = (credits.cast||[]).slice(0,10).map(a => 
                `<div class="actor" onclick="verPessoa('${a.id}')"><img src="${a.profile_path?IMG_AVATAR+a.profile_path:'https://via.placeholder.com/80'}"><p>${a.name}</p></div>`
            ).join('');

            body.innerHTML = `
                <div class="modal-header">
                    <img src="${IMG_URL+data.poster_path}" class="modal-poster">
                    <div class="modal-info">
                        <h2>${data.title||data.name}</h2>
                        <p style="color:#aaa">${data.release_date||data.first_air_date||''}</p>
                        <p style="margin:10px 0; color:#ddd; line-height:1.5">${data.overview||'Sem sinopse.'}</p>
                        <div class="action-row">
                            <span style="color:var(--gold); font-weight:bold">‚òÖ ${data.vote_average.toFixed(1)}</span>
                            ${eyeBtn}
                            <div class="list-toggle" onclick="toggleListMenu(event)">
                                <i class="fa-solid fa-plus"></i> Minhas Listas
                                <div class="list-options" id="listMenu"></div>
                            </div>
                        </div>
                    </div>
                </div>
                ${seasonsHtml}
                <div class="cast-section"><h3>Elenco</h3><div class="cast-list">${htmlElenco}</div></div>
            `;
            
            backupModalFilme = body.innerHTML;
            document.getElementById('reviewTitle').innerText = "üí¨ Coment√°rios (Geral)";
            document.getElementById('reviewsSection').style.display='block';
            loadReviews();
            loadUserListsIntoMenu(); // Corrigido: Carrega lista no modal
        } catch (e) { body.innerHTML = "<p>Erro ao carregar.</p>"; }
    }

    // --- LISTAS ---
    async function loadCustomListsTabs() {
        if(isGuest) return;
        const { data } = await supabase.from('user_lists').select('*').eq('user_id', currentUser.id).eq('is_system', false);
        const tabs = document.getElementById('listsTabs');
        while(tabs.children.length > 2) { tabs.removeChild(tabs.lastChild); }
        
        data.forEach(l => {
            const btn = document.createElement('button');
            btn.className = 'sub-tab-btn';
            btn.innerText = l.name;
            btn.onclick = () => loadUserList(l.id);
            tabs.appendChild(btn);
        });
        
        const createBtn = document.createElement('button');
        createBtn.className = 'sub-tab-btn';
        createBtn.style.color = 'var(--accent)';
        createBtn.innerText = '+ Criar';
        createBtn.onclick = createNewList;
        tabs.appendChild(createBtn);
    }

    async function loadUserList(listId) {
        document.querySelectorAll('.diary-section-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        // (Visual active state needs logic but funcionality works)
        
        currentActiveListId = listId;
        const container = document.getElementById('listContent');
        container.style.display = 'flex'; // Changed to flex for wrap
        container.style.flexWrap = 'wrap';
        container.style.gap = '15px';
        container.innerHTML = "Carregando...";
        
        let query = supabase.from('list_items').select('*').eq('list_id', listId);
        const { data } = await query;
        renderListItems(data, container, true);
    }

    async function renderListItems(data, container, isCustomList = false) {
        container.innerHTML = "";
        
        if (isCustomList) {
             container.innerHTML += `
                <div class="action-card-small delete" onclick="deleteCurrentList()">
                    <i class="fa-solid fa-trash"></i>
                    <span>Excluir Lista</span>
                </div>`;
        }

        container.innerHTML += `
            <div class="action-card-small add" onclick="goToSearch()">
                <i class="fa-solid fa-plus"></i>
                <span>Adicionar</span>
            </div>`;

        if(!data || !data.length) return;

        for(let item of data) {
            container.innerHTML += `
                <div class="card" onclick="abrirModal('${item.tmdb_id}', '${item.media_type}')">
                    <div class="card-remove-btn" onclick="removeListItem('${item.id}'); event.stopPropagation();"><i class="fa-solid fa-xmark"></i></div>
                    <img src="${IMG_URL+item.poster_path}">
                    <div class="rating-badge" style="bottom:0; top:auto; width:100%; text-align:center; background:rgba(0,0,0,0.7); font-size:0.8em">${item.title}</div>
                </div>`;
        }
    }
    
    function goToSearch() {
        navegar('search');
        document.getElementById('searchInput').focus();
    }
    
    async function deleteCurrentList() {
        if(!currentActiveListId) return;
        if(confirm("Excluir esta lista?")) {
            await supabase.from('user_lists').delete().eq('id', currentActiveListId);
            loadCustomListsTabs();
            loadDiary();
        }
    }
    
    async function removeListItem(itemId) {
        if(confirm("Remover item?")) {
            await supabase.from('list_items').delete().eq('id', itemId);
            loadUserList(currentActiveListId);
        }
    }

    // --- MENU LISTAS ---
    async function loadUserListsIntoMenu() {
        if(isGuest) return;
        const menu = document.getElementById('listMenu');
        const { data: lists } = await supabase.from('user_lists').select('*').eq('user_id', currentUser.id);
        
        menu.innerHTML = "";
        const { data: items } = await supabase.from('list_items').select('list_id').eq('tmdb_id', currentItem.id);
        const inLists = new Set(items.map(i => i.list_id));

        lists.forEach(l => {
            const checked = inLists.has(l.id) ? 'fa-check-square' : 'fa-square';
            const color = inLists.has(l.id) ? 'var(--accent)' : '#aaa';
            menu.innerHTML += `
                <div class="list-option-item" onclick="toggleListItem('${l.id}', this)">
                    <span>${l.name}</span>
                    <i class="fa-regular ${checked}" style="color:${color}"></i>
                </div>`;
        });
        
        menu.innerHTML += `
            <div class="list-create-area">
                <input type="text" class="new-list-input" placeholder="Nova lista..." id="newListInput" onclick="event.stopPropagation()">
                <button class="new-list-btn" onclick="createListFromModal(document.getElementById('newListInput').value); event.stopPropagation();"><i class="fa-solid fa-plus"></i></button>
            </div>`;
    }

    function toggleListMenu(e) {
        if(e) e.stopPropagation();
        const menu = document.getElementById('listMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    
    window.onclick = function(event) {
        if (!event.target.closest('.list-toggle')) {
            const m = document.getElementById('listMenu');
            if (m && m.style.display === 'block') m.style.display = 'none';
        }
    }

    async function toggleListItem(lid, el) {
        const icon = el.querySelector('i');
        const isAdded = icon.classList.contains('fa-check-square');
        if(isAdded) {
            await supabase.from('list_items').delete().eq('list_id', lid).eq('tmdb_id', currentItem.id);
            icon.className='fa-regular fa-square';
            icon.style.color = '#aaa';
        } else {
            await supabase.from('list_items').insert([{
                list_id: lid, tmdb_id: currentItem.id, 
                media_type: currentItem.type, poster_path: currentItem.poster, title: currentItem.title 
            }]);
            icon.className='fa-regular fa-check-square';
            icon.style.color = 'var(--accent)';
        }
    }

    async function createListFromModal(name) {
        if(!name) return;
        await supabase.from('user_lists').insert([{ user_id: currentUser.id, name: name }]);
        loadUserListsIntoMenu();
    }
    
    async function createNewList() {
        const name = prompt("Nome da nova lista:");
        if(name) {
            await supabase.from('user_lists').insert([{ user_id: currentUser.id, name: name }]);
            loadCustomListsTabs();
        }
    }

    // --- WATCHED DATE ---
    async function toggleWatch(id, type, runtime, btn, s=null, ep=null) {
        if(isGuest) return alert("Fa√ßa login.");
        const key = type==='movie' ? `${id}_m` : `${id}_tv_${s}_${ep}`;
        if(watchedSet.has(key)) {
            watchedSet.delete(key);
            let q = supabase.from('watched').delete().eq('user_id', currentUser.id).eq('tmdb_id', id);
            if(s) q=q.eq('season_number',s).eq('episode_number',ep);
            await q;
            if(btn && type==='movie') { btn.classList.remove('active'); btn.innerHTML = '<i class="fa-solid fa-eye"></i> Marcar Visto'; }
        } else {
            pendingWatchAction = { id, type, runtime, btn, s, ep, key };
            const now = new Date();
            document.getElementById('watchDate').valueAsDate = now;
            document.getElementById('watchTime').value = now.toTimeString().substring(0,5);
            document.getElementById('dateModal').style.display = 'flex';
        }
    }
    async function confirmWatch() {
        const { id, type, runtime, btn, s, ep, key } = pendingWatchAction;
        const fullDate = new Date(`${document.getElementById('watchDate').value}T${document.getElementById('watchTime').value}`);
        watchedSet.add(key);
        const obj = { user_id: currentUser.id, tmdb_id: id, media_type: type, runtime: runtime, created_at: fullDate.toISOString() };
        if(s) { obj.season_number = s; obj.episode_number = ep; }
        await supabase.from('watched').insert([obj]);
        if(btn && type==='movie') { btn.classList.add('active'); btn.innerHTML = '<i class="fa-solid fa-eye"></i> Visto'; }
        closeDateModal();
    }
    function closeDateModal() { document.getElementById('dateModal').style.display = 'none'; pendingWatchAction = null; }

    // --- S√âRIES L√ìGICA ---
    async function loadSeason(tvId, s) {
        const div = document.getElementById(`season-${s}`);
        const icon = div.previousElementSibling.querySelector('.season-btn i');
        if(div.style.display==='block'){div.style.display='none'; if(icon) icon.className='fa-solid fa-chevron-down'; return;}
        div.style.display='block'; if(icon) icon.className='fa-solid fa-chevron-up';
        div.innerHTML="<p style='padding:10px;color:#666'>Carregando...</p>";
        const res = await fetch(`${BASE_URL}/tv/${tvId}/season/${s}?api_key=${TMDB_KEY}&language=pt-BR`);
        const data = await res.json();
        let h = "";
        data.episodes.forEach(ep => {
            const isW = watchedSet.has(`${tvId}_tv_${s}_${ep.episode_number}`);
            h += `<div class="episode-item"><i class="fa-solid fa-eye episode-eye ${isW?'active':''}" data-ep="${ep.episode_number}" onclick="toggleWatch('${tvId}','tv',${currentItem.runtime},this,${s},${ep.episode_number})"></i><div class="episode-info"><div style="font-weight:bold">${ep.episode_number}. ${ep.name}</div><div style="font-size:0.85em; color:#888">${ep.overview||''}</div><div style="margin-top:5px; color:var(--accent); font-size:0.8em; cursor:pointer" onclick="openEpisodeComments(${s},${ep.episode_number})">üí¨ Comentar este epis√≥dio</div></div></div>`;
        });
        div.innerHTML = h;
        div.setAttribute('data-loaded', 'true');
    }
    async function clickSeasonWatch(tvId, s, btn) {
        const content = document.getElementById(`season-${s}`);
        if(!content.getAttribute('data-loaded')) await loadSeason(tvId, s);
        const isActive = btn.classList.contains('active');
        if(isActive) btn.classList.remove('active'); else btn.classList.add('active');
        const eyes = content.querySelectorAll('.episode-eye');
        for(let e of eyes) {
            const ep = e.getAttribute('data-ep');
            if(!isActive) { if(!e.classList.contains('active')) { e.classList.add('active'); await toggleWatch(tvId, 'tv', 30, null, s, ep); } }
            else { if(e.classList.contains('active')) { e.classList.remove('active'); await toggleWatch(tvId, 'tv', 30, null, s, ep); } }
        }
    }

    // --- BIO & FILMOGRAFIA ---
    async function verPessoa(id) {
        const c = document.getElementById('modalBody');
        c.innerHTML = "<p style='padding:30px'>Carregando bio...</p>";
        document.getElementById('reviewsSection').style.display='none';
        try {
            const [rBio, rCredits] = await Promise.all([
                fetch(`${BASE_URL}/person/${id}?api_key=${TMDB_KEY}&language=pt-BR`),
                fetch(`${BASE_URL}/person/${id}/combined_credits?api_key=${TMDB_KEY}&language=pt-BR`)
            ]);
            const d = await rBio.json();
            const credits = await rCredits.json();
            const works = credits.cast.sort((a,b) => b.popularity - a.popularity).slice(0, 18);
            let worksHtml = `<div class="filmography-grid">`;
            works.forEach(w => {
                 worksHtml += `<div class="filmography-item" onclick="abrirModal('${w.id}', '${w.media_type}')"><img src="${w.poster_path ? IMG_URL+w.poster_path : 'https://via.placeholder.com/100'}"></div>`;
            });
            worksHtml += `</div>`;
            c.innerHTML = `<div style="padding:20px;"><button class="btn-back-modal" onclick="voltarFilme()"><i class="fa-solid fa-arrow-left"></i> Voltar</button><div class="person-view-header"><img src="${d.profile_path?IMG_URL+d.profile_path:'https://via.placeholder.com/100'}" style="width:120px; border-radius:50%"><div><h2 style="margin:0">${d.name}</h2><p style="color:#888">${d.place_of_birth||''}</p></div></div><div class="person-bio" style="margin-top:20px; color:#ccc; line-height:1.6">${d.biography||'Biografia indispon√≠vel.'}</div><h3 style="margin-top:30px;border-bottom:1px solid #333;padding-bottom:10px">Outros Trabalhos</h3>${worksHtml}</div>`;
        } catch(e){ voltarFilme(); }
    }
    function voltarFilme() { document.getElementById('modalBody').innerHTML = backupModalFilme; document.getElementById('reviewsSection').style.display='block'; }

    // --- DIARIO (AGRUPADO) ---
    function switchDiaryTab(type, btn) {
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.diary-section-content').forEach(c => c.style.display = 'none');
        if (type === 'movies') { document.getElementById('diary-movies-container').style.display = 'block'; document.getElementById('listContent').style.display = 'none'; } 
        else if (type === 'series') { document.getElementById('diary-series-container').style.display = 'block'; document.getElementById('listContent').style.display = 'none'; }
    }

    async function loadDiary() {
        if(isGuest) return;
        const cMovies = document.getElementById('diary-movies-container');
        cMovies.innerHTML = "Carregando...";
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id).eq('media_type', 'movie').order('created_at',{ascending:false});
        cMovies.innerHTML = "";
        
        // BOT√ÉO ADICIONAR NO HIST√ìRICO
        cMovies.innerHTML += `<div class="diary-item" style="border:1px dashed #444; justify-content:center; cursor:pointer;" onclick="goToSearch()"><i class="fa-solid fa-plus"></i> <span style="font-weight:bold; margin-left:10px">Adicionar Filme</span></div>`;

        if(data && data.length > 0) {
            for(let i of data) {
                const res = await fetch(`${BASE_URL}/movie/${i.tmdb_id}?api_key=${TMDB_KEY}&language=pt-BR`);
                const m = await res.json();
                const dateStr = new Date(i.created_at).toLocaleDateString('pt-BR');
                cMovies.innerHTML += `
                    <div class="diary-item">
                        <img src="${IMG_URL+m.poster_path}" class="diary-poster" onclick="abrirModal('${i.tmdb_id}','movie')">
                        <div class="diary-info">
                            <div class="diary-date">${dateStr}</div>
                            <div class="diary-title" onclick="abrirModal('${i.tmdb_id}','movie')">${m.title}</div>
                            <div class="diary-meta">Filme ‚Ä¢ ${i.runtime}m</div>
                        </div>
                        <i class="fa-solid fa-trash diary-remove" onclick="toggleWatch('${i.tmdb_id}','movie',0,null);this.parentElement.remove()"></i>
                    </div>`;
            }
        }
        loadDiarySeries();
        switchDiaryTab('movies', document.querySelector('.sub-tab-btn'));
    }

    async function loadDiarySeries() {
        if(isGuest) return;
        const cSeries = document.getElementById('diary-series-container');
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id).eq('media_type', 'tv').order('created_at',{ascending:false});
        cSeries.innerHTML = "";
        
        // BOT√ÉO ADICIONAR NA S√âRIE
        cSeries.innerHTML += `<div class="diary-item" style="border:1px dashed #444; justify-content:center; cursor:pointer;" onclick="goToSearch()"><i class="fa-solid fa-plus"></i> <span style="font-weight:bold; margin-left:10px">Adicionar S√©rie</span></div>`;

        if(!data.length) return;

        let seriesMap = {};
        for(let i of data) {
            if(!seriesMap[i.tmdb_id]) {
                const res = await fetch(`${BASE_URL}/tv/${i.tmdb_id}?api_key=${TMDB_KEY}&language=pt-BR`);
                seriesMap[i.tmdb_id] = { meta: await res.json(), latest: i };
            } else {
                const old = seriesMap[i.tmdb_id].latest;
                if(i.season_number > old.season_number || (i.season_number == old.season_number && i.episode_number > old.episode_number)) {
                    seriesMap[i.tmdb_id].latest = i;
                }
            }
        }
        for (const [id, val] of Object.entries(seriesMap)) {
            const i = val.latest;
            const m = val.meta;
            const dateStr = new Date(i.created_at).toLocaleDateString('pt-BR');
            cSeries.innerHTML += `
                <div class="diary-item">
                    <img src="${IMG_URL+m.poster_path}" class="diary-poster" onclick="abrirModal('${i.tmdb_id}','tv')">
                    <div class="diary-info">
                        <div class="diary-date">√öltimo: ${dateStr}</div>
                        <div class="diary-title" onclick="abrirModal('${i.tmdb_id}','tv')">${m.name}</div>
                        <div class="diary-meta" style="color:var(--gold)">Parou em: T${i.season_number} E${i.episode_number}</div>
                    </div>
                </div>`;
        }
    }

    // --- DETALHES DE STATS ---
    async function openDetailedStats(type) {
        if(isGuest) return;
        document.getElementById('page-stats').classList.remove('active');
        document.getElementById('page-stats-details').classList.add('active');
        const grid = document.getElementById('statsDetailGrid'); grid.innerHTML="Carregando...";
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id).eq('media_type', type).order('created_at', {ascending: false});
        grid.innerHTML="";
        if(!data.length) { grid.innerHTML="<p>Vazio</p>"; return; }
        for(let item of data.slice(0,50)) {
             const res = await fetch(`${BASE_URL}/${type}/${item.tmdb_id}?api_key=${TMDB_KEY}&language=pt-BR`);
             const m = await res.json();
             const label = type === 'tv' ? `<div class="rating-badge" style="bottom:5px; top:auto">S${item.season_number} E${item.episode_number}</div>` : '';
             grid.innerHTML += `<div class="card" onclick="abrirModal('${item.tmdb_id}','${type}')"><img src="${IMG_URL+m.poster_path}">${label}</div>`;
        }
    }
    function closeDetailedStats() { document.getElementById('page-stats-details').classList.remove('active'); document.getElementById('page-stats').classList.add('active'); }
    async function calculateStats() {
        if(isGuest) return;
        const { data } = await supabase.from('watched').select('*').eq('user_id', currentUser.id);
        let m=0, e=0, hM=0, hS=0;
        data.forEach(i=>{ if(i.media_type==='movie') { m++; hM+=i.runtime||0; } else { e++; hS+=i.runtime||0; } });
        document.getElementById('statMovies').innerText=m; document.getElementById('statEpisodes').innerText=e;
        document.getElementById('statHoursMovies').innerText=(hM/60).toFixed(1); document.getElementById('statHoursSeries').innerText=(hS/60).toFixed(1);
        new Chart(document.getElementById('chartGenres'), {type:'bar',data:{labels:['Filmes','Epis√≥dios'],datasets:[{label:'Total',data:[m,e],backgroundColor:['#e50914','#fff']}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#333'}}}}});
    }

    // --- REVIEWS ---
    function setRate(n) { currentRating = n; document.querySelectorAll('#starInput i').forEach((s, i) => { s.className = i < n ? "fa-solid fa-star filled" : "fa-solid fa-star"; }); }
    function openEpisodeComments(s, ep) { currentEpisode = { s, ep }; document.getElementById('reviewTitle').innerText = `üí¨ Coment√°rios: S${s} E${ep}`; loadReviews(); document.getElementById('reviewsSection').scrollIntoView({behavior:'smooth'}); }
    async function loadReviews() {
        let q = supabase.from('reviews').select('*, profiles(username, avatar_url)').eq('movie_id', currentItem.id).order('created_at', {ascending:false});
        if(currentEpisode) q = q.eq('season_number', currentEpisode.s).eq('episode_number', currentEpisode.ep); else q = q.is('season_number', null);
        const { data } = await q;
        const list = document.getElementById('reviewsList'); list.innerHTML = "";
        if(!data || !data.length) { list.innerHTML = "<p style='color:#666; text-align:center'>Nenhum coment√°rio.</p>"; return; }
        data.forEach(r => {
            const stars = "‚òÖ".repeat(r.rating);
            const delBtn = (currentUser && r.user_id === currentUser.id) ? `<i class="fa-solid fa-trash delete-btn" onclick="deleteReview('${r.id}')"></i>` : '';
            list.innerHTML += `<div class="review-box"><div class="review-header"><div class="user-badge"><img src="${r.profiles?.avatar_url||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:25px;height:25px;border-radius:50%"><span>${r.is_anonymous?'An√¥nimo':(r.profiles?.username||'Usu√°rio')}</span></div><span style="color:var(--gold)">${stars}</span></div><div class="review-body">${r.comment}</div><div style="display:flex;justify-content:flex-end;margin-top:5px;">${delBtn}</div></div>`;
        });
    }
    async function publicarReview() {
        if(isGuest) return alert("Fa√ßa login");
        const txt = document.getElementById('reviewText').value;
        if(!txt || !currentRating) return alert("D√™ nota e escreva!");
        const obj = { user_id: currentUser.id, movie_id: currentItem.id, movie_title: currentItem.title, rating: currentRating, comment: txt, is_anonymous: document.getElementById('anonCheck').checked };
        if(currentEpisode) { obj.season_number=currentEpisode.s; obj.episode_number=currentEpisode.ep; }
        const { error } = await supabase.from('reviews').insert([obj]);
        if(error) alert("Erro: " + error.message); else { document.getElementById('reviewText').value=""; setRate(0); loadReviews(); }
    }
    async function deleteReview(id) { if(confirm("Apagar?")) { await supabase.from('reviews').delete().eq('id', id); loadReviews(); } }

    function selectAvatar(url) { document.getElementById('pf-avatar').value=url; updateProfilePreview(); }
    function updateProfilePreview() { document.getElementById('profile-img-preview').src=document.getElementById('pf-avatar').value; document.getElementById('profile-cover-bg').style.backgroundImage=`url('${document.getElementById('pf-banner').value}')`; }
    async function salvarPerfil() {
        if(isGuest) return alert("Visitante n√£o pode editar.");
        const updates = { id: currentUser.id, username: document.getElementById('pf-name').value, avatar_url: document.getElementById('pf-avatar').value, banner_url: document.getElementById('pf-banner').value };
        const { error } = await supabase.from('profiles').upsert(updates);
        if(error) alert("Erro: " + error.message); else { alert("Salvo!"); window.location.reload(); }
    }

    function fecharModal(e){if(e==='botao'||e.target.id==='modalDetalhes')document.getElementById('modalDetalhes').style.display='none'}
    async function buscar(){const t=document.getElementById('searchInput').value; const r=await fetch(`${BASE_URL}/search/multi?api_key=${TMDB_KEY}&language=pt-BR&query=${t}`); const d=await r.json(); const g=document.getElementById('gridBusca'); g.innerHTML=""; d.results.forEach(i=>{if(i.poster_path) g.innerHTML+=`<div class="card" onclick="abrirModal('${i.id}','${i.media_type}')"><img src="${IMG_URL+i.poster_path}"></div>`});}
</script>
</body>
</html>
